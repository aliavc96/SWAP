
# Replicación de bases de datos Mysql


## Introducción

Tendremos una base de datos mastro y una base de datos esclavo.
Cuando una máquina cree una página web hará una escritura a una base de datos, como una cadena de texto. 
El maestro esclavo actúa de modo que la sentencia que le llega al maestro se la pasa al esclavo. Por lo que 
esas bases de datos se encontrarán siempre sincronizadas y disponibles. La máquina de esclavo está 
dedicada exclusivamente a actualizar la información.

Para realizar esta práctica necesitamos dos máquinas con mysql (maquina1 y máquina2)

En la máquina 1 creamos una base de datos, creamos una copia de seguridad de esa 
base de datos y ese archivo lo pasamos a la máquina 2 (a través de scp o rsync) y restauramos el .sql
Posteriormente aplicamos una serie de pasos para configurar el maestro en la máquina 1 y el esclavo en la máquina 2.

## Crear base de datos e insertar datos

Una vez creada la base de datos en la máquina principal (donde he incluido algunas tuplas), he creado una copia con mysqldump, 
puesto que, como muy bien explica el guión, tenemos que asegurar la copia de seguridad para que al realizarla no se lleven a cabo 
modificaciones inapropiadas. Para ello bloqueamos el acceso a las tablas con la sentencia

`FLUSH TABLES WITH READ LOCK` 

![captura 1](https://github.com/aliavc96/SWAP/blob/master/practicas/practica5/imagenes/creandoBaseDatos.jpg)

A continuación copiamos el archivo .sql con la información en la máquina esclavo con del comando scp:

![captura 2](https://github.com/aliavc96/SWAP/blob/master/practicas/practica5/imagenes/copiasqlAesclavo.jpg)

Posteriormente tenemos que llevar a cabo la restauración de la base de datos en la máquina esclavo, para ello creamos una base de datos 
y luego importamos el contenido con el siguiente comando:

`mysql -u root -p copiaContactos < /tmp/contactos.sql`

En la siguiente imagen se puede ver que ha funcionado:

![captura 3](https://github.com/aliavc96/SWAP/blob/master/practicas/practica5/imagenes/contactosClon.jpg)



## Replicación de la BD mediante la configuración maestro-esclavo

"Se trata de un proceso automático que resulta muy adecuado en un entorno de producción real. Implica realizar algunas 
configuraciones tanto en el servidor principal como en el secundario"

Empezaremos aplicando la configuración de la base de datos del maestro en el archivo de configuración de mysql que se encuentra 
en /etc/mysql/mysql.conf.d llamado mysql.cnf y comentaremos el parámetro bind-address que sirve para que se escuche al servidor.

Indicamos la prioridad del servidor como 1 (si es que no la tenía establecida).
Descomentamos el registro binario indicándole la ruta de dónde se encuentra para llevar a cabo las transacciones de una forma más segura.

Por último reiniciamos mysql para que se actualice la configuración con:

`/etc/init.d/mysql restart`

Una vez completada la configuración del maestro (es decir, sin errores) pasamos a completar la configuración del esclavo:
En caso de encontrarnos en una versión inferior a 5.5 tendremos que descomentar y modificar los valores de Master-host, Master-user y Master-password.

Para saber la versión en la que nos encontramos trabajando basta con adentrarnos como administradores en la base de datos de mysql:

`mysql -u root -p`

y poner lo siguiente:

`SHOW VARIABLES LIKE "%VERSION%";`

![captura 4](https://github.com/aliavc96/SWAP/blob/master/practicas/practica5/imagenes/versionEsclavo.jpg)


En mi caso la versión es la 5.7.18 por lo que no he necesitado realizar modificación alguna en el archivo de configuración.

En el mysql del maestro ejecutamos las siguientes sentencias:

![captura 5](https://github.com/aliavc96/SWAP/blob/master/practicas/practica5/imagenes/sentenciasMYSQLmaestro.jpg)

Y ya podemos configurar la máquina segunda como esclavo con el siguiente comando:

![captura 6](https://github.com/aliavc96/SWAP/blob/master/practicas/practica5/imagenes/comando_esclavo.jpg)

Antes de hacer esto es importante que le demos prioridad 2 al servidor esclavo en el archivo de configuración de mysql.

A continuación iniciamos el esclavo con la siguiente sentencia de mysql:

`START SLAVE`

![captura 7](https://github.com/aliavc96/SWAP/blob/master/practicas/practica5/imagenes/STARTSLAVE.jpg)

También he cambiado el nombre del "user" en el archivo de configuración del esclavo puesto que era el mismo que el del maestro y 
causaba un error por el que no permitía realizar su función correctamente.

A continuación se muestra el status del esclavo (vemos que la variable Seconds_Behind_Master está a 0, o sea, ningún error):

![captura 8](https://github.com/aliavc96/SWAP/blob/master/practicas/practica5/imagenes/statusEsclavoFuncionando.png)

He comprobado que creando nuevas entradas en la tabla "datos" de la base de datos del maestro, esas entradas se incluyen también 
en la tabla "datos" de la base de datos del esclavo. Esto indica que funciona correctamente el maestro-esclavo.





